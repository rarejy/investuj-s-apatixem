<!DOCTYPE html>
<html lang="cs" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Investuj s Apatixem</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://unpkg.com/alpinejs@3.10.5/dist/cdn.min.js" defer></script>
  <style>
    :root {
      --gold-light: #d4af37;
      --gold-dark: #b8860b;
      --gold-darker: #daa520;
    }
    .golden-gradient {
      background: linear-gradient(135deg, var(--gold-dark) 0%, var(--gold-darker) 50%, var(--gold-light) 100%);
    }
    .status-new {
      background-color: #dbeafe;
      color: #1e40af;
    }
    .dark .status-new {
      background-color: #1e3a8a;
      color: #bfdbfe;
    }
    .status-agreed {
      background-color: #dcfce7;
      color: #166534;
    }
    .dark .status-agreed {
      background-color: #166534;
      color: #dcfce7;
    }
    .status-disagreed {
      background-color: #fee2e2;
      color: #991b1b;
    }
    .dark .status-disagreed {
      background-color: #991b1b;
      color: #fee2e2;
    }
    .note-bubble {
      background-color: #f3f4f6;
      border-radius: 0.5rem;
      padding: 0.75rem;
      position: relative;
      margin-bottom: 0.75rem;
    }
    .dark .note-bubble {
      background-color: #374151;
    }
    .note-bubble:after {
      content: '';
      position: absolute;
      top: 0.75rem;
      left: -0.5rem;
      width: 1rem;
      height: 1rem;
      transform: rotate(45deg);
      background-color: #f3f4f6;
    }
    .dark .note-bubble:after {
      background-color: #374151;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100" x-data="{ 
  darkMode: localStorage.getItem('darkMode') === 'true',
  activeFilter: 'all',
  showNoteModal: false,
  currentLead: null,
  currentLeadName: '',
  newNote: '',
  notes: [],
  editNoteId: null
}" 
:class="{ 'dark': darkMode }" 
@keydown.escape="showNoteModal = false">
  
  <!-- Header -->
  <header class="golden-gradient shadow-md">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
        </svg>
        <h1 class="text-xl font-bold text-white">Investuj s Apatixem</h1>
      </div>
      <div class="flex items-center space-x-4">
        <button @click="darkMode = !darkMode; localStorage.setItem('darkMode', darkMode); document.documentElement.classList.toggle('dark', darkMode)" 
                class="p-2 rounded-full bg-white/20 hover:bg-white/30 transition">
          <svg x-show="!darkMode" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
          </svg>
          <svg x-show="darkMode" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
        </button>
        <% if (user) { %>
          <span class="text-white"><%= user.username %></span>
          <a href="/auth/logout" class="text-white hover:text-yellow-200 transition">Odhlásit se</a>
        <% } %>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-200 dark:border-gray-700">
      <!-- Filters -->
      <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Přehled kontaktů</h2>
        <div class="flex flex-wrap gap-2">
          <button @click="activeFilter = 'all'" 
                  :class="{ 'bg-indigo-600 text-white': activeFilter === 'all', 'bg-gray-200 dark:bg-gray-700': activeFilter !== 'all' }"
                  class="px-4 py-2 rounded-lg text-sm font-medium transition">
            Všechny
          </button>
          <button @click="activeFilter = 'new'" 
                  :class="{ 'bg-blue-600 text-white': activeFilter === 'new', 'bg-gray-200 dark:bg-gray-700': activeFilter !== 'new' }"
                  class="px-4 py-2 rounded-lg text-sm font-medium transition">
            Nové
          </button>
          <button @click="activeFilter = 'agreed'" 
                  :class="{ 'bg-green-600 text-white': activeFilter === 'agreed', 'bg-gray-200 dark:bg-gray-700': activeFilter !== 'agreed' }"
                  class="px-4 py-2 rounded-lg text-sm font-medium transition">
            Domluvené
          </button>
          <button @click="activeFilter = 'disagreed'" 
                  :class="{ 'bg-red-600 text-white': activeFilter === 'disagreed', 'bg-gray-200 dark:bg-gray-700': activeFilter !== 'disagreed' }"
                  class="px-4 py-2 rounded-lg text-sm font-medium transition">
            Nedomluvené
          </button>
        </div>
      </div>
      
      <!-- Leads Table -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Jméno</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Telefon</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Poznámky</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Akce</th>
            </tr>
          </thead>
          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            <% leads.forEach(lead => { %>
            <tr x-show="activeFilter === 'all' || 
                        (activeFilter === 'new' && '<%= lead.status %>' === 'new') || 
                        (activeFilter === 'agreed' && '<%= lead.status %>' === 'agreed') || 
                        (activeFilter === 'disagreed' && '<%= lead.status %>' === 'disagreed')">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center">
                    <span class="text-indigo-600 dark:text-indigo-300 font-medium">
                      <%= lead.jmeno.charAt(0) %><%= lead.prijmeni.charAt(0) %>
                    </span>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900 dark:text-gray-100"><%= lead.jmeno %> <%= lead.prijmeni %></div>
                    <div class="text-sm text-gray-500 dark:text-gray-400"><%= lead.email || 'Není uveden' %></div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">
                <a href="tel:<%= lead.telefon %>" class="hover:text-indigo-600 dark:hover:text-indigo-400">
                  <%= lead.telefon %>
                </a>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                  <%= lead.status === 'agreed' ? 'status-agreed' : (lead.status === 'disagreed' ? 'status-disagreed' : 'status-new') %>">
                  <%= formatStatus(lead.status) %>
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">
                <button @click="openNotesModal('<%= lead._id %>', '<%= lead.jmeno %> <%= lead.prijmeni %>', <%= JSON.stringify(lead.notes || []).replace(/"/g, '&quot;') %>)"
                        class="<%= (lead.notes && lead.notes.length > 0) ? 'text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300' %>">
                  <% if (lead.notes && lead.notes.length > 0) { %>
                    Zobrazit (<%= lead.notes.length %>)
                  <% } else { %>
                    Přidat
                  <% } %>
                </button>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">
                <div class="flex space-x-3">
                  <form action="/dashboard/update-status/<%= lead._id %>" method="POST" class="inline">
                    <button type="submit" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300">
                      <%= lead.status === 'agreed' ? 'Zrušit' : 'Potvrdit' %>
                    </button>
                  </form>
                  <form action="/dashboard/delete/<%= lead._id %>" method="POST" class="inline" onsubmit="return confirm('Opravdu chcete smazat tohoto leada?');">
                    <button type="submit" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                      Smazat
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Notes Modal -->
  <div x-show="showNoteModal" x-transition class="fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div @click="showNoteModal = false" class="fixed inset-0 transition-opacity" aria-hidden="true">
        <div class="absolute inset-0 bg-gray-500 dark:bg-gray-900 opacity-75"></div>
      </div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100 mb-4">
            Poznámky pro <span x-text="currentLeadName"></span>
          </h3>
          
          <!-- Notes List -->
          <div class="space-y-3 mb-4 max-h-60 overflow-y-auto">
            <template x-for="(note, index) in notes" :key="index">
              <div class="note-bubble">
                <div class="flex justify-between items-start mb-2">
                  <p x-text="note.text" class="text-sm text-gray-800 dark:text-gray-200 flex-1 pr-2"></p>
                  <div class="flex space-x-2 flex-shrink-0">
                    <button @click="editNoteId = index; newNote = note.text" 
                            class="text-gray-500 hover:text-indigo-600 dark:hover:text-indigo-400 p-1">
                      <i class="fas fa-edit text-xs"></i>
                    </button>
                    <button @click="deleteNote(index)" 
                            class="text-gray-500 hover:text-red-600 dark:hover:text-red-400 p-1">
                      <i class="fas fa-trash text-xs"></i>
                    </button>
                  </div>
                </div>
                <div class="flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
                  <span x-text="new Date(note.createdAt).toLocaleString('cs-CZ')"></span>
                  <span x-text="note.createdBy"></span>
                </div>
              </div>
            </template>
            
            <div x-show="notes.length === 0" class="text-center py-8 text-gray-500 dark:text-gray-400">
              <i class="fas fa-sticky-note text-2xl mb-2"></i>
              <p>Žádné poznámky</p>
            </div>
          </div>
          
          <!-- Add/Edit Note Form -->
          <div class="mt-4">
            <textarea x-model="newNote" 
                      rows="3" 
                      class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-md" 
                      placeholder="Nová poznámka..."></textarea>
            <div class="mt-3 flex justify-end space-x-3">
              <button x-show="editNoteId !== null" 
                      @click="cancelEdit()" 
                      type="button" 
                      class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Zrušit
              </button>
              <button @click="saveNote()" 
                      type="button" 
                      :disabled="!newNote.trim()"
                      :class="newNote.trim() ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-gray-400 cursor-not-allowed'"
                      class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <span x-text="editNoteId !== null ? 'Uložit' : 'Přidat'"></span>
              </button>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button @click="showNoteModal = false" 
                  type="button" 
                  class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-600 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Zavřít
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Globální proměnná pro username -->
  <script>
    window.currentUser = '<%= user ? user.username : "Neznámý" %>';
  </script>
  
  <!-- Externí JavaScript soubor -->
  <script src="/js/dashboard.js"></script>
</body>
</html>